---
name: Upload Translations to Koro i18n

'on':
  push:
    branches:
      - main
    paths:
      - 'main/**'
      - 'newtab/**'
      - 'settings/**'
      - 'profile-manager/**'
      - 'welcome/**'
      - 'notes/**'
      - 'stub-win64-installer/**'
  workflow_dispatch:

jobs:
  upload-translations:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC authentication
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare translation files for upload
        run: |
          # Create a temporary locales directory structure for koro-i18n
          # The koro-i18n action expects files in locales/{language}/ directories
          
          # Get all available languages from the newtab directory as reference
          for lang_file in newtab/*.json; do
            if [ -f "$lang_file" ]; then
              lang=$(basename "$lang_file" .json)
              mkdir -p "locales/$lang"
              
              # Copy JSON files from main/{lang}/ directory if it exists
              if [ -d "main/$lang" ]; then
                for file in "main/$lang"/*.json; do
                  if [ -f "$file" ]; then
                    filename=$(basename "$file")
                    cp "$file" "locales/$lang/main-${filename}"
                  fi
                done
              fi
              
              # Copy individual {lang}.json files from other directories
              for dir in newtab settings profile-manager welcome notes stub-win64-installer; do
                if [ -f "$dir/$lang.json" ]; then
                  cp "$dir/$lang.json" "locales/$lang/${dir}.json"
                fi
              done
            fi
          done

          echo "Files prepared for upload:"
          echo "Languages found:"
          ls -d locales/*/ | wc -l
          echo "Total files:"
          find locales -name "*.json" | wc -l
          echo ""
          echo "Sample structure (first 3 languages):"
          ls -la locales/ | head -10

      - name: Upload translations to Koro i18n
        uses: f3liz-dev/koro-i18n/.github/actions/upload-translations@main
        with:
          project-name: floorp-i18n-unofficial
          mode: json
