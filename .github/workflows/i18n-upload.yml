---
name: Upload Translations to Koro i18n

'on':
  push:
    branches:
      - main
    paths:
      - 'main/**'
      - 'newtab/**'
      - 'settings/**'
      - 'profile-manager/**'
      - 'welcome/**'
      - 'notes/**'
      - 'stub-win64-installer/**'
      - '.koro-i18n.repo.config.toml'
  workflow_dispatch:

jobs:
  upload-translations:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC authentication
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare translation files for upload
        run: |
          # Create a temporary locales directory structure for koro-i18n
          # The koro-i18n action expects files in locales/{language}/ directories
          
          # Read source language from config file
          SOURCE_LANG=$(grep -E "^sourceLanguage" .koro-i18n.repo.config.toml | sed -E 's/.*=\s*"([^"]+)".*/\1/')
          
          if [ -z "$SOURCE_LANG" ]; then
            echo "Error: Could not find sourceLanguage in .koro-i18n.repo.config.toml"
            exit 1
          fi
          
          echo "Source language: $SOURCE_LANG"
          echo "Preparing source language files for upload to translation platform..."
          
          # Create directory for source language only
          mkdir -p "locales/$SOURCE_LANG"
          
          # Copy JSON files from main/{SOURCE_LANG}/ directory if it exists
          if [ -d "main/$SOURCE_LANG" ]; then
            for file in "main/$SOURCE_LANG"/*.json; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                cp "$file" "locales/$SOURCE_LANG/main-${filename}"
                echo "  Copied: main/$SOURCE_LANG/${filename}"
              fi
            done
          fi
          
          # Copy individual {SOURCE_LANG}.json files from other directories
          for dir in newtab settings profile-manager welcome notes \
              stub-win64-installer; do
            if [ -f "$dir/$SOURCE_LANG.json" ]; then
              cp "$dir/$SOURCE_LANG.json" "locales/$SOURCE_LANG/${dir}.json"
              echo "  Copied: $dir/$SOURCE_LANG.json"
            fi
          done
          
          echo ""
          echo "========================================="
          echo "Source language files prepared for upload:"
          echo "Language: $SOURCE_LANG"
          echo "Total files:"
          find locales -name "*.json" | wc -l
          echo ""
          echo "Files to be uploaded:"
          ls -la "locales/$SOURCE_LANG/"
          echo "========================================="

      - name: Upload translations to Koro i18n
        uses: f3liz-dev/koro-i18n/.github/actions/upload-translations@main
        with:
          project-name: floorp-i18n-unofficial
          mode: json
